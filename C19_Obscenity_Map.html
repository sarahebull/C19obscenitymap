<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapping Nineteenth-Century Obscenity</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  :root { --rust: #B7472A; --ochre: #C8973E; --olive: #6B7F4E; --teal: #2D6D6D; --tan: #D4C5A9; --cream: #F5F0E8; --ink: #2C2418; --ink-light: #5C5142; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Source Sans 3', sans-serif; background: var(--cream); color: var(--ink); }
  #map { width: 100%; height: 100vh; }
  .control-panel { position: absolute; top: 16px; left: 60px; z-index: 1000; background: var(--cream); border: 1px solid var(--tan); border-radius: 3px; padding: 20px 24px; width: 360px; box-shadow: 0 2px 12px rgba(44,36,24,0.15); max-height: calc(100vh - 32px); overflow-y: auto; }
  .control-panel h1 { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; line-height: 1.3; margin-bottom: 16px; padding-right: 30px; }
  .control-section { margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid var(--tan); }
  .control-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  .control-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--ink-light); margin-bottom: 8px; display: block; }
  .time-display { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; color: var(--rust); text-align: center; margin-bottom: 4px; letter-spacing: 1px; }
  .time-range-label { font-size: 11px; color: var(--ink-light); text-align: center; margin-bottom: 10px; }
  input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--tan); border-radius: 3px; outline: none; cursor: pointer; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--rust); border-radius: 50%; cursor: pointer; border: 2px solid var(--cream); box-shadow: 0 1px 4px rgba(44,36,24,0.3); }
  input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; background: var(--rust); border-radius: 50%; cursor: pointer; border: 2px solid var(--cream); }
  .window-control { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .window-control label { font-size: 12px; color: var(--ink-light); white-space: nowrap; }
  select { padding: 4px 6px; font-size: 12px; font-family: 'Source Sans 3', sans-serif; border: 1px solid var(--tan); border-radius: 2px; background: white; color: var(--ink); cursor: pointer; }
  .basemap-select { width: 100%; padding: 5px 6px; }
  .play-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
  .play-btn { background: var(--teal); color: white; border: none; border-radius: 2px; padding: 5px 14px; font-family: 'Source Sans 3', sans-serif; font-size: 12px; font-weight: 600; letter-spacing: 0.5px; cursor: pointer; }
  .play-btn:hover { background: #245858; }
  .count-display { font-size: 13px; color: var(--ink); text-align: center; padding: 6px 0; }
  .count-display strong { font-weight: 600; color: var(--rust); }
  .leaflet-popup-content-wrapper { border-radius: 3px; font-family: 'Source Sans 3', sans-serif; }
  .leaflet-popup-content { margin: 12px 16px; font-size: 13px; line-height: 1.5; min-width: 200px; }
  .popup-name { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 700; margin-bottom: 4px; }
  .popup-year { font-size: 12px; font-weight: 600; color: var(--rust); margin-bottom: 4px; }
  .popup-address { font-size: 12px; color: var(--ink-light); margin-bottom: 6px; }
  .popup-source { font-size: 10px; color: var(--teal); letter-spacing: 0.3px; font-style: italic; }
  .histogram { display: flex; align-items: flex-end; gap: 1px; height: 40px; margin-top: 6px; }
  .hist-bar { flex: 1; background: var(--tan); border-radius: 1px 1px 0 0; transition: background 0.3s; cursor: pointer; min-width: 2px; }
  .hist-bar.active { background: var(--rust); }
  .hist-bar:hover { opacity: 0.8; }
  .hist-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--ink-light); margin-top: 2px; }
  .collapse-btn { position: absolute; top: 8px; right: 8px; background: none; border: 1px solid var(--tan); border-radius: 2px; width: 24px; height: 24px; font-size: 14px; color: var(--ink-light); cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .collapse-btn:hover { background: var(--tan); }
  .control-panel.collapsed { width: auto; padding: 12px 16px; }
  .control-panel.collapsed .panel-content { display: none; }
  .control-panel.collapsed h1 { font-size: 14px; margin-bottom: 0; }
  .marker-cluster div { font-family: 'Source Sans 3', sans-serif; font-weight: 600; font-size: 12px; }
  .marker-cluster-small { background-color: rgba(183,71,42,0.25); }
  .marker-cluster-small div { background-color: var(--rust); color: white; }
  .marker-cluster-medium { background-color: rgba(183,71,42,0.3); }
  .marker-cluster-medium div { background-color: var(--rust); color: white; }
  .marker-cluster-large { background-color: rgba(183,71,42,0.35); }
  .marker-cluster-large div { background-color: var(--rust); color: white; }
  .map-legend { position: absolute; bottom: 28px; right: 12px; z-index: 1000; background: rgba(245,240,232,0.95); border: 1px solid var(--tan); border-radius: 3px; padding: 8px 12px; font-size: 11px; color: var(--ink-light); line-height: 1.7; }
  .map-legend a { color: var(--teal); }
  .nls-note { font-size: 10px; color: var(--ink-light); margin-top: 8px; line-height: 1.4; }
  .nls-note a { color: var(--teal); }
  #tileStatus { font-size: 10px; color: var(--rust); margin-top: 6px; min-height: 14px; }
  .year-input-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .year-input-row label { font-size: 12px; color: var(--ink-light); white-space: nowrap; }
  .year-input { width: 60px; padding: 4px 6px; font-size: 13px; font-family: 'Playfair Display', serif; font-weight: 700; color: var(--rust); border: 1px solid var(--tan); border-radius: 2px; background: white; text-align: center; }
  .year-input:focus { outline: none; border-color: var(--rust); }
  .year-go-btn { background: var(--teal); color: white; border: none; border-radius: 2px; padding: 4px 10px; font-family: 'Source Sans 3', sans-serif; font-size: 11px; font-weight: 600; cursor: pointer; }
  .year-go-btn:hover { background: #245858; }
  @media (max-width: 700px) {
    .control-panel { left: 8px; right: 8px; top: 8px; width: auto; padding: 14px 16px; }
    .control-panel h1 { font-size: 15px; }
    .time-display { font-size: 22px; }
  }
</style>
</head>
<body>
<div id="map"></div>
<div class="control-panel" id="controlPanel">
  <button class="collapse-btn" id="collapseBtn" title="Collapse panel">&minus;</button>
  <h1>Mapping Nineteenth-Century Obscenity</h1>
  <div class="panel-content">
    <div class="control-section">
      <span class="control-label">Time Period</span>
      <div class="time-display" id="timeDisplay">1822 &ndash; 1870</div>
      <div class="time-range-label" id="timeRangeLabel">Showing all records</div>
      <input type="range" id="timeSlider" min="1820" max="1875" value="1820" step="1">
      <div class="window-control">
        <label for="windowSize">Window:</label>
        <select id="windowSize">
          <option value="0" selected>All years</option>
          <option value="5">&plusmn;5 years</option>
          <option value="10">&plusmn;10 years</option>
          <option value="1">Single year</option>
        </select>
      </div>
      <div class="year-input-row">
        <label for="yearInput">Go to year:</label>
        <input type="number" id="yearInput" class="year-input" min="1820" max="1875" placeholder="1850">
        <button class="year-go-btn" id="yearGoBtn">Go</button>
      </div>
      <div class="histogram" id="histogram"></div>
      <div class="hist-labels" id="histLabels"></div>
      <div class="play-row"><button class="play-btn" id="playBtn">&#9654; Play</button></div>
    </div>
    <div class="control-section">
      <span class="control-label">Visible</span>
      <div class="count-display" id="countDisplay"><strong>114</strong> of 114 addresses shown</div>
    </div>
    <div class="control-section">
      <span class="control-label">Base Map</span>
      <select id="basemapSelect" class="basemap-select">
        <optgroup label="Modern">
          <option value="osmBW">OpenStreetMap (greyscale)</option>
          <option value="osm">OpenStreetMap (colour)</option>
        </optgroup>
        <optgroup label="NLS Historical &mdash; London">
          <option value="os6inch" selected>OS Six-Inch County, 1830s&ndash;1880s</option>
          <option value="london1850s">OS London 1:5280, 1848&ndash;51</option>
          <option value="london1870s">OS London 1:1250, 1862&ndash;74</option>
          <option value="london1890s">OS London 1:2500, 1893&ndash;96</option>
        </optgroup>
      </select>
      <div id="tileStatus"></div>
      <p class="nls-note">
        Historic georeferenced map layers from the
        <a href="https://maps.nls.uk/" target="_blank">National Library of Scotland</a>.
        The Six-Inch County layer combines Middlesex, Surrey, and Kent for London coverage.
        For locations outside London, switch to a modern base map.
      </p>
    </div>
  </div>
</div>
<div class="map-legend">Historic maps &copy; <a href="https://maps.nls.uk/" target="_blank">NLS</a>, <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC-BY 3.0 Unported</a></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
var DATA = [{"name": "William Benbow", "years": [1825], "year": 1825, "address": "252 High Holborn", "lat": 51.517334901118716, "lon": -0.1177837, "description": "William Benbow, 1825, 252 High Holborn"}, {"name": "Louis Dubois", "years": [1861], "year": 1861, "address": "9 Dyer's Buildings, Holborn Bars, E.C., removed from 25, Bedford Row", "lat": 51.51754517348286, "lon": -0.11014337, "description": "Louis Dubois, 1861, 9 Dyer's Buildings, Holborn Bars, E.C., removed from 25, Bedford Row"}, {"name": "Weir", "years": [1864, 1865], "year": 1864, "address": "23 Featherstone-buildings, Holborn, London, W.C.", "lat": 51.51849903203535, "lon": -0.116104269, "description": "Weir, 1864-1865, 23 Featherstone-buildings, Holborn, London, W.C."}, {"name": "T.T.T", "years": [1861], "year": 1861, "address": "66, Cheapside, E.C.", "lat": 51.521245074740904, "lon": -0.087458857, "description": "T.T.T, 1861, 66, Cheapside, E.C."}, {"name": "Edward Duncombe", "years": [1828], "year": 1828, "address": "28 Fleet-market", "lat": 51.52317193076891, "lon": -0.1077881, "description": "Edward Duncombe, 1828, 28 Fleet-market"}, {"name": "Louis Dubois", "years": [1861, 1862], "year": 1861, "address": "25 Bedford Row, London, W.C.", "lat": 51.52037955384753, "lon": -0.116685782, "description": "Louis Dubois, 1861-1862, 25 Bedford Row, London, W.C."}, {"name": "Paul de Paris", "years": [1857, 1863, 1864, 1866], "year": 1857, "address": "2 Holywell Street, Strand, London", "lat": 51.51298275605498, "lon": -0.114923367, "description": "Paul de Paris, 1857, 1863-1864, 1866, 2 Holywell Street, Strand, London"}, {"name": "Theophilus Sebastian Judge", "years": [1868, 1869], "year": 1868, "address": "2, Holywell-street, Strand, London", "lat": 51.513001595734465, "lon": -0.114909987, "description": "Theophilus Sebastian Judge, 1868-1869,  2, Holywell-street, Strand, London"}, {"name": "Thomas Paine Carlile", "years": [1848], "year": 1848, "address": "252 Strand (from 103)", "lat": 51.513183642257076, "lon": -0.113914633, "description": "Thomas Paine Carlile, 1848, 252 Strand (from 103)"}, {"name": "Mons Louise", "years": [1846], "year": 1846, "address": "18, Arundel-street, Strand", "lat": 51.51153757693913, "lon": -0.113647946, "description": "Mons Louise, 1846, 18, Arundel-street, Strand"}, {"name": "Croker and Co", "years": [1844, 1845], "year": 1844, "address": "199 Strand, corner of Milford-lane", "lat": 51.51278831613138, "lon": -0.113561164, "description": "Croker and Co, 1844-1845, 199 Strand, corner of Milford-lane"}, {"name": "Emile Levine", "years": [1857], "year": 1857, "address": "31, Rue de Colisses [sic], Paris and 195, Waterloo Bridge-road, London, England", "lat": 51.50069842689291, "lon": -0.107799762, "description": "Emile Levine, 1857, 31, Rue de Colisses [sic], Paris and 195, Waterloo Bridge-road, London, England"}, {"name": "Edward Duncombe", "years": [1851, 1852, 1853, 1854], "year": 1851, "address": "7 West-street, Upper St. Martin's-lane", "lat": 51.51332846995396, "lon": -0.128699414, "description": "Edward Duncombe, 1851-1854, 7 West-street, Upper St. Martin's-lane"}, {"name": "Edward Duncombe", "years": [1854, 1855, 1856, 1857, 1858, 1859, 1860, 1861, 1862, 1863, 1864, 1865, 1866], "year": 1854, "address": "28, Little St. Andrew-street, Upper St. Martin's-Lane", "lat": 51.51354220317364, "lon": -0.127239034, "description": "Edward Duncombe, 1854-1866, 28, Little St. Andrew-street, Upper St. Martin's-Lane"}, {"name": "Edward Duncombe", "years": [1838, 1839, 1840, 1841, 1842, 1843], "year": 1838, "address": "78, Long-acre, Drury-lane", "lat": 51.514461941454584, "lon": -0.12240625, "description": "Edward Duncombe, 1838-1843, 78, Long-acre, Drury-lane"}, {"name": "Novello and Co", "years": [1843], "year": 1843, "address": "78 Long Acre", "lat": 51.51446378247178, "lon": -0.122398934, "description": "Novello and Co, 1843, 78 Long Acre"}, {"name": "Jackson and Co", "years": [1844], "year": 1844, "address": "78, Long Acre", "lat": 51.51446947288807, "lon": -0.122401194, "description": "Jackson and Co, 1844, 78, Long Acre"}, {"name": "Edward Duncombe", "years": [1837, 1838], "year": 1837, "address": "180, High Holborn", "lat": 51.51575467698089, "lon": -0.125339886, "description": "Edward Duncombe, 1837-1838, 180, High Holborn"}, {"name": "Anderson", "years": [1865, 1866, 1867, 1868, 1869, 1870], "year": 1865, "address": "32 Bidborough Street, London, W.C.", "lat": 51.52862605944682, "lon": -0.126010215, "description": "Anderson, 1865-1870, 32 Bidborough Street, London, W.C."}, {"name": "Henry May", "years": [1854, 1856], "year": 1854, "address": "17, Holywell-street, Strand", "lat": 51.512527088450526, "lon": -0.116164789, "description": "Henry May, 1854, 1856, 17, Holywell-street, Strand"}, {"name": "William John Dugdale", "years": [1849, 1850], "year": 1849, "address": "35 Holywell Street, Strand", "lat": 51.51255670225402, "lon": -0.116119212, "description": "William John Dugdale, 1849-1850, 35 Holywell Street, Strand"}, {"name": "William Dugdale", "years": [1839, 1840, 1841, 1842, 1843, 1844, 1845, 1846, 1847, 1848, 1849, 1850, 1851, 1852, 1853], "year": 1839, "address": "37 Holywell-Street, Strand", "lat": 51.512573952594465, "lon": -0.116102554, "description": "William Dugdale, 1839-1853, 37 Holywell-Street, Strand"}, {"name": "Felix Danjer (William Dugdale?)", "years": [1854], "year": 1854, "address": "37 Holywell-Street, Strand", "lat": 51.51257448968039, "lon": -0.116095866, "description": "Felix Danjer (William Dugdale?), 1854, 37 Holywell-Street, Strand"}, {"name": "William Dugdale", "years": [1863], "year": 1863, "address": "37 Holywell-Street, Strand", "lat": 51.51258016744538, "lon": -0.116085017, "description": "William Dugdale, 1863, 37 Holywell-Street, Strand"}, {"name": "George Jones", "years": [1865], "year": 1865, "address": "34 Holywell Street Strand W.C.", "lat": 51.51261877921428, "lon": -0.115986593, "description": "George Jones, 1865, 34 Holywell Street Strand W.C."}, {"name": "Richard Groves", "years": [1864, 1865, 1866, 1867, 1868, 1869], "year": 1864, "address": "33 Holywell Street, Strand", "lat": 51.512641348916986, "lon": -0.11594083, "description": "Richard Groves, 1864-1869, 33 Holywell Street, Strand"}, {"name": "Michael Saunders", "years": [1866], "year": 1866, "address": "49 Wych-street, Strand, W.C.", "lat": 51.51306383734135, "lon": -0.115558955, "description": "Michael Saunders, 1866, 49 Wych-street, Strand, W.C."}, {"name": "John Higdon Thornhill", "years": [1856, 1857], "year": 1856, "address": "53 Holywell Street, Strand, London", "lat": 51.51284751338889, "lon": -0.115304531, "description": "John Higdon Thornhill, 1856-1857, 53 Holywell Street, Strand, London"}, {"name": "Emile Levine", "years": [1857], "year": 1857, "address": "62, Wych-street, Strand, London", "lat": 51.513138392597426, "lon": -0.115206219, "description": "Emile Levine, 1857, 62, Wych-street, Strand, London"}, {"name": "John Lambert Dugdale", "years": [1856, 1857], "year": 1856, "address": "50 Holywell Street, Strand", "lat": 51.512892949343836, "lon": -0.115199771, "description": "John Lambert Dugdale, 1856-1857, 50 Holywell Street, Strand"}, {"name": "William Dugdale", "years": [1857], "year": 1857, "address": "5 Holywell Street, Strand", "lat": 51.51294549739069, "lon": -0.115018396, "description": "William Dugdale, 1857, 5 Holywell Street, Strand"}, {"name": "Richard Martin", "years": [1856, 1857], "year": 1856, "address": "183 Fleet Street", "lat": 51.514147537298726, "lon": -0.110005316, "description": "Richard Martin, 1856-1857, 183 Fleet Street"}, {"name": "William Edwards", "years": [1842, 1843, 1844, 1845, 1846, 1847, 1848, 1849, 1850, 1851], "year": 1842, "address": "183 Fleet-Street", "lat": 51.51415048653041, "lon": -0.110012439, "description": "William Edwards, 1842-1851, 183 Fleet-Street"}, {"name": "William Ward", "years": [1855, 1856, 1857, 1858, 1859], "year": 1855, "address": "113, Fleet-street, near Ludgate-hill", "lat": 51.51418943227006, "lon": -0.109779752, "description": "William Ward, 1855-1859, 113, Fleet-street, near Ludgate-hill"}, {"name": "Edward Duncombe", "years": [1826, 1827], "year": 1826, "address": "188 Fleet Street", "lat": 51.51437582949714, "lon": -0.105600462, "description": "Edward Duncombe, 1826-1827, 188 Fleet Street"}, {"name": "Edward Duncombe", "years": [1826], "year": 1826, "address": "165 Fleet Street", "lat": 51.514390674343616, "lon": -0.10778666, "description": "Edward Duncombe, 1826, 165 Fleet Street"}, {"name": "William Ward", "years": [1849, 1850, 1851], "year": 1849, "address": "67 Strand, nearly facing the Adelphi Theatre", "lat": 51.509680846729196, "lon": -0.123851679, "description": "William Ward, 1849-1851, 67 Strand, nearly facing the Adelphi Theatre"}, {"name": "Thomas Ward (Thomas Paine Carlile) and Frederick Glover", "years": [1845], "year": 1845, "address": "103, Strand", "lat": 51.51059805624058, "lon": -0.120644209, "description": "Thomas Ward (Thomas Paine Carlile) and Frederick Glover, 1845, 103, Strand"}, {"name": "Thomas Paine Carlile", "years": [1843, 1844, 1845, 1846, 1847, 1848], "year": 1843, "address": "103, Strand", "lat": 51.51060744619872, "lon": -0.12070305, "description": "Thomas Paine Carlile, 1843-1848, 103, Strand"}, {"name": "Thomas Paine Carlile", "years": [1849], "year": 1849, "address": "2, St. Martin's-Court, St. Martin's Lane", "lat": 51.510914434407056, "lon": -0.127602726, "description": "Thomas Paine Carlile, 1849, 2, St. Martin's-Court, St. Martin's Lane"}, {"name": "Judge Family", "years": [1870], "year": 1870, "address": "6 Exeter-street, Strand, London", "lat": 51.511197318528076, "lon": -0.121616861, "description": "Judge Family, 1870, 6 Exeter-street, Strand, London"}, {"name": "George Cannon", "years": [1829], "year": 1829, "address": "16, Ryder's Court, Leicester Square", "lat": 51.511322221270916, "lon": -0.127856507, "description": "George Cannon, 1829, 16, Ryder's Court, Leicester Square"}, {"name": "Frederick Glover", "years": [1846, 1847], "year": 1846, "address": "22, St. Martin's-court, Leicester-square", "lat": 51.51112242001608, "lon": -0.127859319, "description": "Frederick Glover, 1846-1847, 22, St. Martin's-court, Leicester-square"}, {"name": "George Cannon", "years": [1848], "year": 1848, "address": "11, May's-buildings, Saint Martin's-lane", "lat": 51.51028487647241, "lon": -0.126661738, "description": "George Cannon, 1848, 11, May's-buildings, Saint Martin's-lane"}, {"name": "William Dugdale", "years": [1852, 1854, 1855, 1856], "year": 1852, "address": "16 Holywell Street", "lat": 51.512499947577396, "lon": -0.116285461, "description": "William Dugdale, 1852, 1854, 1855-1856, 16 Holywell Street"}, {"name": "H.G. Brooks", "years": [1856], "year": 1856, "address": "17 1/2 Holywell Street, Strand, London", "lat": 51.51250913332052, "lon": -0.116197738, "description": "H.G. Brooks, 1856, 17 1/2 Holywell Street, Strand, London"}, {"name": "William Dugdale", "years": [1863, 1864, 1865, 1866, 1867, 1868], "year": 1863, "address": "44 Wych-street, Strand, London, W.C.", "lat": 51.51295983049553, "lon": -0.116188616, "description": "William Dugdale, 1863-1868, 44 Wych-street, Strand, London, W.C."}, {"name": "Theophilus Sebastian Judge", "years": [1869], "year": 1869, "address": "44 Wych-street, Strand, London.", "lat": 51.51295840181035, "lon": -0.116265061, "description": "Theophilus Sebastian Judge, 1869, 44 Wych-street, Strand, London."}, {"name": "Judge Family (Jessie Judge?)", "years": [1869, 1870], "year": 1869, "address": "44 Wych-street, Strand, London.", "lat": 51.51295035264468, "lon": -0.11625781, "description": "Judge Family (Jessie Judge?), 1869-1870, 44 Wych-street, Strand, London."}, {"name": "Edward Duncombe", "years": [1843, 1844], "year": 1843, "address": "338 Oxford Street", "lat": 51.514729207736366, "lon": -0.147687762, "description": "Edward Duncombe, 1843-1844, 338 Oxford Street"}, {"name": "Jackson and Co", "years": [1841, 1842, 1843, 1844], "year": 1841, "address": "130 New Bond Street", "lat": 51.511893105298526, "lon": -0.144479044, "description": "Jackson and Co, 1841-1844, 130 New Bond Street"}, {"name": "John Benjamin Brookes", "years": [1839], "year": 1839, "address": "9, New Bond Street", "lat": 51.51006346394601, "lon": -0.14188626, "description": "John Benjamin Brookes, 1839, 9, New Bond Street"}, {"name": "John Benjamin Brookes", "years": [1828], "year": 1828, "address": "4, Royal Arcade, Pall Mall", "lat": 51.507919283789704, "lon": -0.131967462, "description": "John Benjamin Brookes, 1828, 4, Royal Arcade, Pall Mall"}, {"name": "Frederick Glover", "years": [1844, 1845], "year": 1844, "address": "47, Haymarket", "lat": 51.51002452534624, "lon": -0.132955165, "description": "Frederick Glover, 1844-1845, 47, Haymarket"}, {"name": "Edward Duncombe", "years": [1845, 1846], "year": 1845, "address": "86 Wardour-street, Oxford-street", "lat": 51.51335210583633, "lon": -0.133764172, "description": "Edward Duncombe, 1845-1846, 86 Wardour-street, Oxford-street"}, {"name": "William Ward", "years": [1855], "year": 1855, "address": "48 1/2 Haymarket", "lat": 51.50947334, "lon": -0.133148296, "description": "William Ward, 1855, 48 1/2 Haymarket"}, {"name": "Edward Dyer", "years": [1847, 1848, 1849, 1850, 1851, 1852, 1853, 1854, 1855, 1856, 1857, 1858, 1859, 1860, 1861, 1862, 1863, 1864, 1865], "year": 1847, "address": "24 Princes-street, Soho", "lat": 51.51466284064591, "lon": -0.142436341, "description": "Edward Dyer, 1847-1865, 24 Princes-street, Soho"}, {"name": "Judge Family", "years": [1859, 1860, 1861, 1862, 1863, 1864, 1865], "year": 1859, "address": "50 Carlton Road, Kentish Town, London, N.W.", "lat": 51.54989543382166, "lon": -0.149156978, "description": "Judge Family, 1859-1865, 50 Carlton Road, Kentish Town, London, N.W."}, {"name": "Thomas Paine Carlile", "years": [1850], "year": 1850, "address": "38 Arundel Street, Strand", "lat": 51.51151084031076, "lon": -0.113510357, "description": "Thomas Paine Carlile, 1850, 38 Arundel Street, Strand"}, {"name": "Edward Duncombe", "years": [1828, 1829, 1830, 1831, 1832, 1833, 1834, 1835], "year": 1828, "address": "18 Middle Row, Holborn", "lat": 51.51812266129812, "lon": -0.111843371, "description": "Edward Duncombe, 1828-1835, 18 Middle Row, Holborn"}, {"name": "John Duncombe", "years": [1836, 1837, 1838, 1839, 1840, 1841, 1842, 1843, 1849], "year": 1836, "address": "10, Middle Row, Holborn", "lat": 51.518088815222626, "lon": -0.11159834, "description": "John Duncombe, 1836-1843, 1849, 10, Middle Row, Holborn"}, {"name": "Edward Duncombe", "years": [1850], "year": 1850, "address": "17, Holborn, opposite Furnival's-inn", "lat": 51.51851827381918, "lon": -0.108930738, "description": "Edward Duncombe, 1850, 17, Holborn, opposite Furnival's-inn"}, {"name": "\"Beta\"", "years": [1853, 1854], "year": 1853, "address": "8, Tudor-street, City", "lat": 51.5126309, "lon": -0.105602374, "description": "\"Beta\",\" 1853-1854, 8, Tudor-street, City"}, {"name": "Edward Duncombe", "years": [1837], "year": 1837, "address": "18, Skinner-street, Snowhill, London", "lat": 51.51698146961465, "lon": -0.104062215, "description": "Edward Duncombe, 1837, 18, Skinner-street, Snowhill, London"}, {"name": "John Duncombe", "years": [1823, 1824, 1825, 1826, 1827, 1828, 1829, 1830, 1831, 1832, 1833, 1834, 1835], "year": 1823, "address": "19, Little Queen-street, Holborn", "lat": 51.51699489480373, "lon": -0.120280486, "description": "John Duncombe, 1823-1835, 19, Little Queen-street, Holborn"}, {"name": "Edward Duncombe", "years": [1836], "year": 1836, "address": "26, Chichester-place, Gray's Inn-road", "lat": 51.52883397198076, "lon": -0.120249003, "description": "Edward Duncombe, 1836, 26, Chichester-place, Gray's Inn-road"}, {"name": "Thomas Paine Carlile", "years": [1849], "year": 1849, "address": "No. 1 A Catherine-street, Strand", "lat": 51.51208338108364, "lon": -0.119548872, "description": "Thomas Paine Carlile, 1849, No. 1 A Catherine-street, Strand"}, {"name": "John Higdon Thornhill", "years": [1866], "year": 1866, "address": "22, Newcastle-street, Strand, W.C.", "lat": 51.51272118126343, "lon": -0.116899164, "description": "John Higdon Thornhill, 1866, 22, Newcastle-street, Strand, W.C."}, {"name": "William Benbow", "years": [1822, 1823], "year": 1822, "address": "9, Castle-street, Leicester-square", "lat": 51.51077849045416, "lon": -0.128632528, "description": "William Benbow, 1822-1823, 9, Castle-street, Leicester-square"}, {"name": "J. Brooks and Co (Frederick Hunt)", "years": [1849], "year": 1849, "address": "66, Castle-street, Leicester-square", "lat": 51.50988348598804, "lon": -0.128438466, "description": "J. Brooks and Co (Frederick Hunt), 1849, 66, Castle-street, Leicester-square"}, {"name": "James Brewer", "years": [1863, 1864], "year": 1863, "address": "30 Castle Street, Leicester Square, London, W.C.", "lat": 51.51034434251403, "lon": -0.128431499, "description": "James Brewer, 1863-1864, 30 Castle Street, Leicester Square, London, W.C."}, {"name": "Cole (James Brewer?)", "years": [1867], "year": 1867, "address": "30 Castle Street, Leicester Square, London", "lat": 51.51034569908987, "lon": -0.128426617, "description": "Cole (James Brewer?), 1867, 30 Castle Street, Leicester Square, London"}, {"name": "Williams and Co", "years": [1845], "year": 1845, "address": "1, Bridge-court, Bridge-street Westminster", "lat": 51.50129260747556, "lon": -0.125395575, "description": "Williams and Co, 1845, 1, Bridge-court, Bridge-street Westminster"}, {"name": "A. Cooper", "years": [1853, 1854], "year": 1853, "address": "4, Oval-road, Kennington", "lat": 51.48267695435064, "lon": -0.114445741, "description": "A. Cooper, 1853-1854, 4, Oval-road, Kennington"}, {"name": "William Ward", "years": [1869, 1870], "year": 1869, "address": "36, Fleet-lane, E.C.", "lat": 51.51458567267292, "lon": -0.109738488, "description": "William Ward, 1869-1870, 36, Fleet-lane, E.C."}, {"name": "Thomas Martin", "years": [1856], "year": 1856, "address": "14, Fetter-lane, London", "lat": 51.51462171448259, "lon": -0.109731583, "description": "Thomas Martin, 1856, 14, Fetter-lane, London"}, {"name": "\"Stereo\"", "years": [1857], "year": 1857, "address": "7, Tudor-street, Blackfriars, E.C.", "lat": 51.5126609, "lon": -0.105572374, "description": "\"Stereo\",\" 1857, 7, Tudor-street, Blackfriars, E.C."}, {"name": "William Ward", "years": [1864, 1865], "year": 1864, "address": "3, Hatfield-street, Goswell-street, London, E.C. (late of Kennington)", "lat": 51.522547411417065, "lon": -0.096110374, "description": "William Ward, 1864-1865, 3, Hatfield-street, Goswell-street, London, E.C. (late of Kennington)"}, {"name": "Harry Jones", "years": [1861], "year": 1861, "address": "2B, Nelson Place, Old Kent Road, London, S.E.", "lat": 51.486837639690094, "lon": -0.074684102, "description": "Harry Jones, 1861, 2B, Nelson Place, Old Kent Road, London, S.E."}, {"name": "William Ward", "years": [1859, 1860], "year": 1859, "address": "19, York-row, Kennington-road, London, S", "lat": 51.490119626726454, "lon": -0.104470458, "description": "William Ward, 1859-1860, 19, York-row, Kennington-road, London, S"}, {"name": "William Ward", "years": [1861, 1862, 1863, 1864], "year": 1861, "address": "5 Triangle, Kennington Cross, 8", "lat": 51.49119278, "lon": -0.103420266, "description": "William Ward, 1861 - 1864, 5 Triangle, Kennington Cross, 8"}, {"name": "Box U [no name provided]", "years": [1864], "year": 1864, "address": "Box U, Central News Rooms, 151, Cheapside, E.C.", "lat": 51.51457170975587, "lon": -0.0964245, "description": "Box U [no name provided], 1864, Box U, Central News Rooms, 151, Cheapside, E.C."}, {"name": "Henry Reynolds", "years": [1848], "year": 1848, "address": "38, Princes-street, Soho", "lat": 51.51455203463337, "lon": -0.142327532, "description": "Henry Reynolds, 1848, 38, Princes-street, Soho"}, {"name": "Edward Duncombe", "years": [1847, 1848, 1849], "year": 1847, "address": "25 King-street, Covent Garden", "lat": 51.50607640619435, "lon": -0.138151858, "description": "Edward Duncombe, 1847-1849, 25 King-street, Covent Garden"}, {"name": "William Ward", "years": [1852], "year": 1852, "address": "16 Bridges-street, Covent Garden", "lat": 51.51254528572727, "lon": -0.120120446, "description": "William Ward, 1852, 16 Bridges-street, Covent Garden"}, {"name": "Lowe", "years": [1864], "year": 1864, "address": "Strand Museum, London", "lat": 51.51137529687861, "lon": -0.116500696, "description": "Lowe, 1864, Strand Museum, London"}, {"name": "Eugene Alfred Judge", "years": [1865, 1866, 1867, 1868, 1869, 1870], "year": 1865, "address": "Little Heath, Potter's Bar, London N.", "lat": 51.70576242240239, "lon": -0.178436816, "description": "Eugene Alfred Judge, 1865-1870, Little Heath, Potter's Bar, London N."}, {"name": "James [H. James, Esq]", "years": [1866], "year": 1866, "address": "Percy House, Bedford Square, London", "lat": 51.51873184198368, "lon": -0.129594917, "description": "James [H. James, Esq], 1866, Percy House, Bedford Square, London"}, {"name": "Anderson", "years": [1864], "year": 1864, "address": "Acton Cottage, Acton-street, W.C.", "lat": 51.52853597583507, "lon": -0.118421642, "description": "Anderson, 1864, Acton Cottage, Acton-street, W.C."}, {"name": "John Harrison", "years": [1867, 1868, 1869], "year": 1867, "address": "41 Kenton-street, Brunswick-square, W.C.", "lat": 51.525654100779576, "lon": -0.124721511, "description": "John Harrison, 1867-1869, 41 Kenton-street, Brunswick-square, W.C."}, {"name": "Johnson", "years": [1865, 1866], "year": 1865, "address": "Church-road, Hackney, London", "lat": 51.56157071205641, "lon": -0.081355366, "description": "Johnson, 1865-1866, Church-road, Hackney, London"}, {"name": "William Powell", "years": [1868], "year": 1868, "address": "31 Bournemouth road, Peckam, S", "lat": 51.46925274397765, "lon": -0.067359104, "description": "William Powell, 1868, 31 Bournemouth road, Peckam, S"}, {"name": "Chapman", "years": [1868], "year": 1868, "address": "Post Office, Ramgate", "lat": 51.334375311844866, "lon": 1.418292085359562, "description": "Chapman, 1868, Post Office, Ramgate"}, {"name": "Harry Jones", "years": [1861], "year": 1861, "address": "37 William-street, Hampstead-road, London, N.W.", "lat": 51.52707958277912, "lon": -0.141780793, "description": "Harry Jones, 1861, 37 William-street, Hampstead-road, London, N.W."}, {"name": "Weir", "years": [1864], "year": 1864, "address": "10a, Charles-street, Middlesex Hospital, London, W.", "lat": 51.51866159471231, "lon": -0.137899514, "description": "Weir, 1864, 10a, Charles-street, Middlesex Hospital, London, W."}, {"name": "Edward Duncombe", "years": [1866], "year": 1866, "address": "9 West-street, Upper S. Martin's-lane", "lat": 51.51302310831824, "lon": -0.12838436, "description": "Edward Duncombe, 1866, 9 West-street, Upper S. Martin's-lane"}, {"name": "Edward Duncombe", "years": [1867], "year": 1867, "address": "18, Little St. Andrew's Street, St. Martin's Lane", "lat": 51.51354869572651, "lon": -0.127176774, "description": "Edward Duncombe, 1867, 18, Little St. Andrew's Street, St. Martin's Lane"}, {"name": "William Sandyfirth Grayson", "years": [1867, 1868, 1869], "year": 1867, "address": "9 Stanhope-street, Strand, W.C.", "lat": 51.51420407242884, "lon": -0.118866816, "description": "William Sandyfirth Grayson, 1867-1869, 9 Stanhope-street, Strand, W.C."}, {"name": "Sidney", "years": [1868], "year": 1868, "address": "3, Mount Pleasant, Clerkenwell, W.C.", "lat": 51.52337561957259, "lon": -0.112255165, "description": "Sidney, 1868, 3, Mount Pleasant, Clerkenwell, W.C."}, {"name": "Armstrong", "years": [1868], "year": 1868, "address": "11, Samford-street [Blandford Street?], Portman Market, Marylebone, N.W.", "lat": 51.51827581703506, "lon": -0.15480942, "description": "Armstrong, 1868, 11, Samford-street [Blandford Street?], Portman Market, Marylebone, N.W."}, {"name": "Samuel Wilson", "years": [1863], "year": 1863, "address": "North Villa, Alford, Lincoln", "lat": 53.263875463716346, "lon": 0.17834542206846055, "description": "Samuel Wilson, 1863, North Villa, Alford, Lincoln"}, {"name": "Cruden", "years": [1865, 1866, 1869, 1870], "year": 1865, "address": "Tinsley, Rotherham", "lat": 53.39250297328965, "lon": -1.395651886, "description": "Cruden, 1865-1866, 1869-1870, Tinsley, Rotherham"}, {"name": "William Gilliam", "years": [1870], "year": 1870, "address": "Attercliffe, Sheffield", "lat": 53.39848511889974, "lon": -1.426996135, "description": "William Gilliam, 1870, Attercliffe, Sheffield"}, {"name": "Benjamin Smith", "years": [1870], "year": 1870, "address": "6, Oil Mill Folds, Rotherham", "lat": 53.428093592009475, "lon": -1.357121213, "description": "Benjamin Smith, 1870, 6, Oil Mill Folds, Rotherham"}, {"name": "Palmer", "years": [1870], "year": 1870, "address": "14 Merchant-street, Bristol", "lat": 51.45722688106349, "lon": -2.588288432, "description": "Palmer, 1870, 14 Merchant-street, Bristol"}, {"name": "Henry Cook", "years": [1870], "year": 1870, "address": "9 Rosemary Street, Bristol", "lat": 51.45782879794797, "lon": -2.588610359, "description": "Henry Cook, 1870, 9 Rosemary Street, Bristol"}, {"name": "Peterson", "years": [1869, 1870], "year": 1869, "address": "25 James-street, Stockwell, London [specified both N and S in advertisements]", "lat": 51.476025441032704, "lon": -0.104159736, "description": "Peterson, 1869-1870, 25 James-street, Stockwell, London [specified both N and S in advertisements]"}, {"name": "G. Ward", "years": [1864, 1865], "year": 1864, "address": "57 London-road, S.", "lat": 51.49678543348992, "lon": -0.102706832, "description": "G. Ward, 1864-1865, 57 London-road, S."}, {"name": "Herbert Constantine Judge", "years": [1870], "year": 1870, "address": "1 Lucas-place, Wandsworth-road, S", "lat": 51.47374585614642, "lon": -0.151817457, "description": "Herbert Constantine Judge, 1870, 1 Lucas-place, Wandsworth-road, S"}, {"name": "Eugene Alfred Judge", "years": [1870], "year": 1870, "address": "Potter's Bar, London, N.", "lat": 51.694437976755495, "lon": -0.173606359, "description": "Eugene Alfred Judge, 1870, Potter's Bar, London, N."}, {"name": "Denman", "years": [1869], "year": 1869, "address": "5 Union-buildings, near Holborn, London, E.C.", "lat": 51.516917791901136, "lon": -0.102064372, "description": "Denman, 1869, 5 Union-buildings, near Holborn, London, E.C."}, {"name": "Henry Cook", "years": [1866], "year": 1866, "address": "Bristol", "lat": 51.45308687902698, "lon": -2.600815326, "description": "Henry Cook, 1866, Bristol"}, {"name": "Lampert [Theophilus Sebastian Judge and Jessie Judge?]", "years": [1866, 1867, 1868, 1869], "year": 1866, "address": "2 Booksellers' Row, Strand, London", "lat": 51.51295203471176, "lon": -0.114892523, "description": "Lampert [Theophilus Sebastian Judge and Jessie Judge?], 1866-1869, 2 Booksellers' Row, Strand, London"}, {"name": "Smith", "years": [1866, 1867], "year": 1866, "address": "43, Vaughn-road, Cold Harbour-lane, Brixton, S.", "lat": 51.46750158, "lon": -0.098664477, "description": "Smith, 1866\u20131867, 43, Vaughn-road, Cold Harbour-lane, Brixton, S."}];

function formatYears(years) {
  if (!years || years.length === 0) return 'Unknown';
  if (years.length === 1) return '' + years[0];
  var sorted = years.slice().sort(function(a, b) { return a - b; });
  var ranges = [], start = sorted[0], prev = sorted[0];
  for (var i = 1; i < sorted.length; i++) {
    if (sorted[i] === prev + 1) { prev = sorted[i]; }
    else { ranges.push(start === prev ? '' + start : start + '\u2013' + prev); start = sorted[i]; prev = sorted[i]; }
  }
  ranges.push(start === prev ? '' + start : start + '\u2013' + prev);
  return ranges.join(', ');
}

var map = L.map('map', { center: [51.513, -0.118], zoom: 15, minZoom: 5, maxZoom: 20 });

var nlsAttr = 'Historic georeferenced map layers &copy; <a href="https://maps.nls.uk/">NLS</a>, <a href="https://creativecommons.org/licenses/by/3.0/">CC-BY 3.0 Unported</a>';

var modernFallback = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 20, subdomains: 'abcd',
  attribution: '&copy; <a href="https://openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>'
});

var baseLayers = {
  osm: L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>'
  }),
  osmBW: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19, subdomains: 'abcd',
    attribution: '&copy; <a href="https://openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>'
  }),
  os6inch: L.layerGroup([
    L.tileLayer('https://mapseries-tilesets.s3.amazonaws.com/os/six-inch-middlesex/{z}/{x}/{y}.png', {
      maxZoom: 17, attribution: nlsAttr
    }),
    L.tileLayer('https://mapseries-tilesets.s3.amazonaws.com/os/six-inch-surrey/{z}/{x}/{y}.png', {
      maxZoom: 17, attribution: nlsAttr
    }),
    L.tileLayer('https://mapseries-tilesets.s3.amazonaws.com/os/six-inch-kent/{z}/{x}/{y}.png', {
      maxZoom: 17, attribution: nlsAttr
    })
  ]),
  london1850s: L.tileLayer('https://mapseries-tilesets.s3.amazonaws.com/os/town-england/London-5280/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: nlsAttr
  }),
  london1870s: L.tileLayer('https://mapseries-tilesets.s3.amazonaws.com/os/town-england/London-1870s/{z}/{x}/{y}.png', {
    maxZoom: 20, attribution: nlsAttr
  }),
  london1890s: L.tileLayer('https://mapseries-tilesets.s3.amazonaws.com/london_1890s/{z}/{x}/{y}.png', {
    maxZoom: 20, attribution: nlsAttr
  })
};

var historicalKeys = ['os6inch', 'london1850s', 'london1870s', 'london1890s'];
var useFallback = true;

var tileStatus = document.getElementById('tileStatus');
var tileOkCount = {};
function monitorLayer(key, layer) {
  tileOkCount[key] = 0;
  layer.on('tileerror', function() {
    if (tileOkCount[key] === 0) tileStatus.textContent = 'Some tiles unavailable for this layer/zoom \u2013 try zooming in or out.';
  });
  layer.on('tileload', function() { tileOkCount[key]++; if (tileOkCount[key] >= 2) tileStatus.textContent = ''; });
}
Object.keys(baseLayers).forEach(function(k) {
  var layer = baseLayers[k];
  if (layer.getLayers) { layer.getLayers().forEach(function(child, i) { monitorLayer(k + '_' + i, child); }); }
  else { monitorLayer(k, layer); }
});

modernFallback.addTo(map);
var currentBase = baseLayers.os6inch;
currentBase.addTo(map);

document.getElementById('basemapSelect').addEventListener('change', function() {
  map.removeLayer(currentBase);
  if (useFallback) map.removeLayer(modernFallback);
  currentBase = baseLayers[this.value];
  useFallback = historicalKeys.indexOf(this.value) !== -1;
  if (useFallback) modernFallback.addTo(map);
  currentBase.addTo(map);
  tileStatus.textContent = '';
});

var icon = L.divIcon({
  className: '',
  html: '<svg width="14" height="14" viewBox="0 0 14 14"><circle cx="7" cy="7" r="6" fill="#B7472A" stroke="white" stroke-width="1.5" opacity="0.85"/></svg>',
  iconSize: [14, 14], iconAnchor: [7, 7], popupAnchor: [0, -8]
});
var allMarkers = DATA.map(function(d) {
  var yearStr = formatYears(d.years);
  var popup = '<div class="popup-name">' + (d.name || 'Unknown') + '</div>' +
    '<div class="popup-year">' + yearStr + '</div>' +
    '<div class="popup-address">' + (d.address || '') + '</div>' +
    '<div class="popup-source"><em>Advertising Pornography, 1822\u20131870</em></div>';
  var m = L.marker([d.lat, d.lon], { icon: icon }).bindPopup(popup);
  m._data = d;
  return m;
});

var clusterGroup = L.markerClusterGroup({
  maxClusterRadius: 25,
  spiderfyOnMaxZoom: true,
  spiderfyDistanceMultiplier: 3,
  showCoverageOnHover: false,
  disableClusteringAtZoom: 17,
  iconCreateFunction: function(cluster) {
    var c = cluster.getChildCount(), s = c > 20 ? 'large' : c > 8 ? 'medium' : 'small';
    return L.divIcon({ html: '<div>' + c + '</div>', className: 'marker-cluster marker-cluster-' + s, iconSize: L.point(36, 36) });
  }
});
map.addLayer(clusterGroup);

var YEAR_MIN = 1820, YEAR_MAX = 1875;
var currentYear = YEAR_MIN, windowSize = 0, isPlaying = false, playInterval = null;

function updateMarkers() {
  clusterGroup.clearLayers();
  var count = 0;
  allMarkers.forEach(function(marker) {
    var d = marker._data;
    if (windowSize === 0) { clusterGroup.addLayer(marker); count++; return; }
    var yr = d.year;
    if (!yr) return;
    if (windowSize === 1) { if (d.years.indexOf(currentYear) === -1) return; }
    else { if (yr < currentYear - windowSize || yr > currentYear + windowSize) return; }
    clusterGroup.addLayer(marker);
    count++;
  });
  document.getElementById('countDisplay').innerHTML = '<strong>' + count + '</strong> of ' + DATA.length + ' addresses shown';
  updateHistogram();
}

var timeSlider = document.getElementById('timeSlider');
var timeDisplay = document.getElementById('timeDisplay');
var timeRangeLabel = document.getElementById('timeRangeLabel');
var windowSelect = document.getElementById('windowSize');

function updateTimeDisplay() {
  windowSize = parseInt(windowSelect.value);
  if (windowSize === 0) { timeDisplay.textContent = '1822 \u2013 1870'; timeRangeLabel.textContent = 'Showing all records'; }
  else if (windowSize === 1) { timeDisplay.textContent = '' + currentYear; timeRangeLabel.textContent = 'Showing only ' + currentYear; }
  else { timeDisplay.textContent = Math.max(YEAR_MIN, currentYear - windowSize) + ' \u2013 ' + Math.min(YEAR_MAX, currentYear + windowSize); timeRangeLabel.textContent = 'Centred on ' + currentYear; }
}

function goToYear(yr) {
  yr = Math.max(YEAR_MIN, Math.min(YEAR_MAX, yr));
  currentYear = yr;
  timeSlider.value = yr;
  if (windowSize === 0) { windowSelect.value = '1'; windowSize = 1; }
  updateTimeDisplay();
  updateMarkers();
}

timeSlider.addEventListener('input', function() { currentYear = parseInt(this.value); updateTimeDisplay(); updateMarkers(); });
windowSelect.addEventListener('change', function() { updateTimeDisplay(); updateMarkers(); });

var yearInput = document.getElementById('yearInput');
document.getElementById('yearGoBtn').addEventListener('click', function() {
  var v = parseInt(yearInput.value);
  if (!isNaN(v)) goToYear(v);
});
yearInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { var v = parseInt(this.value); if (!isNaN(v)) goToYear(v); }
});

var playBtn = document.getElementById('playBtn');
playBtn.addEventListener('click', function() { isPlaying ? stopPlay() : startPlay(); });
function startPlay() {
  isPlaying = true; playBtn.innerHTML = '&#9632; Stop';
  if (windowSize === 0) { windowSelect.value = '10'; windowSize = 10; }
  if (currentYear >= YEAR_MAX - 2) { currentYear = YEAR_MIN; timeSlider.value = YEAR_MIN; }
  playInterval = setInterval(function() {
    currentYear++;
    if (currentYear > YEAR_MAX) { stopPlay(); return; }
    timeSlider.value = currentYear;
    updateTimeDisplay();
    updateMarkers();
  }, 400);
}
function stopPlay() { isPlaying = false; playBtn.innerHTML = '&#9654; Play'; clearInterval(playInterval); }

// Histogram: count entries where the year appears in the years array
// (not just d.year, which is the earliest year)
function buildHistogram() {
  var c = document.getElementById('histogram');
  var labelsEl = document.getElementById('histLabels');
  var startY = 1822, endY = 1870;
  var counts = [];
  for (var y = startY; y <= endY; y++) {
    var n = 0;
    for (var j = 0; j < DATA.length; j++) {
      if (DATA[j].years && DATA[j].years.indexOf(y) !== -1) n++;
    }
    counts.push({ year: y, count: n });
  }
  var mx = Math.max.apply(null, counts.map(function(d) { return d.count; }).concat([1]));
  c.innerHTML = '';
  counts.forEach(function(d) {
    var bar = document.createElement('div');
    bar.className = 'hist-bar';
    bar.style.height = Math.max(2, (d.count / mx) * 100) + '%';
    bar.title = d.year + ': ' + d.count;
    bar.dataset.year = d.year;
    bar.addEventListener('click', function() { goToYear(d.year); });
    c.appendChild(bar);
  });
  labelsEl.innerHTML = '';
  for (var y = 1820; y <= 1870; y += 10) {
    var span = document.createElement('span');
    span.textContent = y;
    labelsEl.appendChild(span);
  }
}

function updateHistogram() {
  document.querySelectorAll('.hist-bar').forEach(function(bar) {
    var y = parseInt(bar.dataset.year);
    if (windowSize === 0) bar.classList.add('active');
    else if (windowSize === 1) bar.classList.toggle('active', y === currentYear);
    else bar.classList.toggle('active', y >= currentYear - windowSize && y <= currentYear + windowSize);
  });
}

document.getElementById('collapseBtn').addEventListener('click', function() {
  var p = document.getElementById('controlPanel');
  p.classList.toggle('collapsed');
  this.textContent = p.classList.contains('collapsed') ? '+' : '\u2212';
});

buildHistogram();
updateTimeDisplay();
updateMarkers();
</script>
</body>
</html>
